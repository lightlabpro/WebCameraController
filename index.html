<!doctype html>
<html>
<head>
    <title>Permission Controller</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; }
        .ready { background: #198754; }
        .waiting { background: #ffc107; color: #000; }
        .error { background: #dc3545; }
        button { padding: 15px 20px; border: none; border-radius: 8px; background: #0d6efd; color: white; margin: 10px; font-size: 16px; }
        .info { background: #f8f9fa; color: #212529; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <h1>üì± Permission Controller</h1>
    
    <div id="status" class="status waiting">
        <strong>Status:</strong> <span id="statusText">Requesting permissions...</span>
    </div>
    
    <div class="info">
        <h3>Permission Status:</h3>
        <div id="permissionInfo">Checking...</div>
    </div>
    
    <div class="info">
        <h3>Orientation Data:</h3>
        <div id="orientationData">Waiting for permissions...</div>
    </div>
    
    <button onclick="requestPermissions()">üîê Request Permissions</button>
    <button onclick="startBroadcasting()" id="startBtn" disabled>Start Broadcasting</button>
    <button onclick="stopBroadcasting()" id="stopBtn" disabled>Stop Broadcasting</button>
    
    <div class="info">
        <h3>Debug Info:</h3>
        <div id="debugInfo">Initializing...</div>
    </div>
    
    <script>
        let isBroadcasting = false;
        let alpha = 0, beta = 0, gamma = 0;
        let gotOrientation = false;
        let permissionStatus = "Unknown";
        
        // Update status display
        function updateStatus(text, className) {
            document.getElementById('statusText').textContent = text;
            document.getElementById('status').className = `status ${className}`;
        }
        
        // Update permission info
        function updatePermissionInfo() {
            const info = document.getElementById('permissionInfo');
            info.innerHTML = `
                <strong>Motion Permission:</strong> ${permissionStatus}<br>
                <strong>Device Orientation:</strong> ${gotOrientation ? 'Available' : 'Not Available'}<br>
                <strong>Alpha:</strong> ${alpha !== null ? alpha.toFixed(1) : 'null'}<br>
                <strong>Beta:</strong> ${beta !== null ? beta.toFixed(1) : 'null'}<br>
                <strong>Gamma:</strong> ${gamma !== null ? gamma.toFixed(1) : 'null'}
            `;
        }
        
        // Request permissions actively
        async function requestPermissions() {
            updateStatus("Requesting permissions...", "waiting");
            
            try {
                // Check if we need to request permissions
                if (window.DeviceMotionEvent && typeof DeviceMotionEvent.requestPermission === 'function') {
                    updateStatus("Requesting motion permission...", "waiting");
                    const motionResult = await DeviceMotionEvent.requestPermission();
                    console.log("Motion permission result:", motionResult);
                    
                    if (motionResult === 'granted') {
                        updateStatus("Motion permission granted!", "ready");
                    } else {
                        updateStatus("Motion permission denied", "error");
                    }
                }
                
                if (window.DeviceOrientationEvent && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    updateStatus("Requesting orientation permission...", "waiting");
                    const orientationResult = await DeviceOrientationEvent.requestPermission();
                    console.log("Orientation permission result:", orientationResult);
                    
                    if (orientationResult === 'granted') {
                        updateStatus("Orientation permission granted!", "ready");
                    } else {
                        updateStatus("Orientation permission denied", "error");
                    }
                }
                
                // Check if we have permissions now
                checkPermissions();
                
            } catch (error) {
                console.error("Permission request error:", error);
                updateStatus("Permission request failed: " + error.message, "error");
            }
        }
        
        // Check current permission status
        function checkPermissions() {
            // Check if we can access device orientation
            if (window.DeviceOrientationEvent) {
                // Try to add a listener to see if it works
                const testEvent = new Event('deviceorientation');
                if (testEvent) {
                    permissionStatus = "Available";
                    updateStatus("Permissions available!", "ready");
                    document.getElementById('startBtn').disabled = false;
                    return;
                }
            }
            
            permissionStatus = "Not Available";
            updateStatus("Permissions not available - try requesting again", "error");
            document.getElementById('startBtn').disabled = true;
        }
        
        // Device orientation event
        window.addEventListener('deviceorientation', (e) => {
            console.log("Device orientation event:", e);
            
            if (e.alpha !== null && e.beta !== null && e.gamma !== null) {
                alpha = e.alpha;
                beta = e.beta;
                gamma = e.gamma;
                gotOrientation = true;
                
                updateStatus("Receiving orientation data!", "ready");
                document.getElementById('startBtn').disabled = false;
                
                if (isBroadcasting) {
                    updateOrientationDisplay();
                }
            } else {
                console.log("Orientation values are null:", e);
            }
            
            updatePermissionInfo();
        }, true);
        
        // Update orientation display
        function updateOrientationDisplay() {
            if (gotOrientation) {
                const q = [alpha/180, beta/180, gamma/180, 1.0];
                document.getElementById('orientationData').innerHTML = 
                    `<strong>Orientation: [${q.map(v => v.toFixed(4)).join(', ')}]</strong><br>
                     Raw: Alpha=${alpha.toFixed(1)}¬∞, Beta=${beta.toFixed(1)}¬∞, Gamma=${gamma.toFixed(1)}¬∞`;
            }
        }
        
        // Start broadcasting
        function startBroadcasting() {
            if (!gotOrientation) {
                updateStatus("No orientation data available", "error");
                return;
            }
            
            isBroadcasting = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            
            updateStatus("Broadcasting orientation data to Unity...", "ready");
            
            // Update continuously
            const interval = setInterval(() => {
                if (isBroadcasting && gotOrientation) {
                    updateOrientationDisplay();
                } else {
                    clearInterval(interval);
                }
            }, 100);
            
            window.broadcastInterval = interval;
        }
        
        // Stop broadcasting
        function stopBroadcasting() {
            isBroadcasting = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            updateStatus("Stopped broadcasting", "waiting");
            
            if (window.broadcastInterval) {
                clearInterval(window.broadcastInterval);
                window.broadcastInterval = null;
            }
        }
        
        // Initialize
        function init() {
            updateStatus("Initializing...", "waiting");
            updatePermissionInfo();
            
            // Check permissions after a short delay
            setTimeout(() => {
                checkPermissions();
            }, 1000);
        }
        
        // Start initialization
        init();
    </script>
</body>
</html>
